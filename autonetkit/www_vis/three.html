
<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="underscore-min.js"></script>
    <script type="text/javascript" src="jquery.tipsy.js"></script>
    <script type="text/javascript" src="jquery.ba-bbq.min.js"></script>


    <link href="tipsy.css" rel="stylesheet" type="text/css" />
    <link href="font-awesome.min.css" rel="stylesheet" type="text/css" />
    <title>AutoNetkit</title>

    <link rel="stylesheet" type="text/css" href="default.css" title = "default">

    <link rel="alternate stylesheet" type="text/css" title="maximised" href = "maximised.css">

    <link rel="stylesheet" type="text/css" media="print" href="print.css">
    



    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="underscore-min.js"></script>
    <script type="text/javascript" src="jquery.tipsy.js"></script>
    <script type="text/javascript" src="jquery.ba-bbq.min.js"></script>
    <script src="three.min.js"></script>


      </head>
   <body>


      <script type="text/javascript">


var socket_url = "ws://" + location.host + "/ws";
socket_url += "?uuid={{ uuid }}"; //Webserver template fills in the uuid

overlay_id = "phy";

var ws = new WebSocket(socket_url);
ws.onopen = function() {
    ws.send("overlay_list");
    ws.send("overlay_id=" + overlay_id);
};
ws.onclose = function () {
};

jsondata = [];

ws.onmessage = function (evt) {
    var data = jQuery.parseJSON(evt.data);
    //TODO: parse to see if valid traceroute path or other data
    if ("graph" in data) {
        if (overlay_id != "ip_allocations"){
            jsondata = data;
            build();
        }
    }
  
}

</script>


<title>three.js css3d - molecules</title>
        <style>
            html, body {
                height: 100%;
            }

            body {
                background-color: #050505;
                background: rgb(43,45,48); /* Old browsers */
                margin: 0;
                font-family: Arial;
                overflow: hidden;
            }

            a {
                color: #ffffff;
            }


            .bond {
                width: 5px;
                height: 10px;
                background: #eee;
                display: block;
            }
        </style>
    </head>
    <body>
        <script src="three-css3d.min.js"></script>
        <!--
        <script src="js/controls/TrackballControls.js"></script>
        <script src="js/renderers/CSS3DRenderer.js"></script>
    -->
            <div id="container"></div>



        <script>


            var colorSpriteMap = {};
            var baseSprite = document.createElement( 'img' );

            var menu = document.getElementById( "menu" );

             var camera, scene, renderer;
            var controls;
            var root;

            var objects = [];
            var tmpVec1 = new THREE.Vector3();
            var tmpVec2 = new THREE.Vector3();
            var tmpVec3 = new THREE.Vector3();
            var tmpVec4 = new THREE.Vector3();


            geometryAtoms = new THREE.Geometry(),
            geometryBonds = new THREE.Geometry();

            geometryAtoms.elements = [];


        function build() {
           
            var atoms = [];
            var bonds = [];
            var devices = [];
            var links = [];

            for (index in jsondata.nodes) {
                var device = jsondata.nodes[index];
                var x = device['x'];
                var y = device['y'];
                var z = 1;

                var position = new THREE.Vector3( x, y, z );
                geometryAtoms.vertices.push( position );

                var color = new THREE.Color();
                var r = 100;
                var g = 200;
                var b = 250;
                color.setRGB( r, g, b );
                geometryAtoms.colors.push( color );
            }

            console.log(jsondata.links);
            for (index in jsondata.links) {
                var link = jsondata.links[index];
                var start = link['source'];
                var end = link['target'];

                var vertex1 = geometryAtoms.vertices[ start ];
                var vertex2 = geometryAtoms.vertices[ end ];

                geometryBonds.vertices.push( vertex1.clone() );
                geometryBonds.vertices.push( vertex2.clone() );


            }



            for ( var i = 0; i < atoms.length; i ++ ) {

                var atom = atoms[ i ];

                var x = atom[ 0 ];
                var y = atom[ 1 ];
                var z = atom[ 2 ];

                var position = new THREE.Vector3( x, y, z );
                geometryAtoms.vertices.push( position );

                var r = atom[ 3 ][ 0 ] / 255;
                var g = atom[ 3 ][ 1 ] / 255;
                var b = atom[ 3 ][ 2 ] / 255;
                var color = new THREE.Color();
                color.setRGB( r, g, b );

                geometryAtoms.colors.push( color );

                geometryAtoms.elements.push( atom[ 4 ] );

            }

            for ( var i = 0; i < bonds.length; i ++ ) {

                var bond = bonds[ i ];

                var start = bond[ 0 ];
                var end = bond[ 1 ];

                var vertex1 = geometryAtoms.vertices[ start ];
                var vertex2 = geometryAtoms.vertices[ end ];

                geometryBonds.vertices.push( vertex1.clone() );
                geometryBonds.vertices.push( vertex2.clone() );

            }


            init();
            animate();
        }

            function init() {

                camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 5000 );
                camera.position.z = 1500;

                scene = new THREE.Scene();

                root = new THREE.Object3D();
                scene.add( root );

                //

                renderer = new THREE.CSS3DRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.getElementById( 'container' ).appendChild( renderer.domElement );

                //

                //controls = new THREE.TrackballControls( camera, renderer.domElement );
                //controls.rotateSpeed = 0.5;
                //controls.addEventListener( 'change', render );

                //

                baseSprite.onload = function () {

                    console.log("here");
                    loadMolecule( "models/molecules/caffeine.pdb" );
                    showAtomsBonds();

                };

                baseSprite.src = 'icons/router.svg';

                //

                window.addEventListener( 'resize', onWindowResize, false );

            }

            //

            function generateButtonCallback( url ) {

                return function ( event ) {

                    loadMolecule( url );

                }

            }

            function showAtoms() {

                for ( var i = 0; i < objects.length; i ++ ) {

                    var object = objects[ i ];

                    if ( object instanceof THREE.CSS3DSprite ) {

                        object.element.style.display = "";
                        object.visible = true;

                    } else {

                        object.element.style.display = "none";
                        object.visible = false;

                    }

                }

            }

            function showBonds() {

                for ( var i = 0; i < objects.length; i ++ ) {

                    var object = objects[ i ];

                    if ( object instanceof THREE.CSS3DSprite ) {

                        object.element.style.display = "none";
                        object.visible = false;

                    } else {

                        object.element.style.display = "";
                        object.element.style.height = object.userData.bondLengthFull;
                        object.visible = true;

                    }

                }

            }

            function showAtomsBonds() {

                for ( var i = 0; i < objects.length; i ++ ) {

                    var object = objects[ i ];

                    object.element.style.display = "";
                    object.visible = true;

                    if ( ! ( object instanceof THREE.CSS3DSprite ) ) {

                        object.element.style.height = object.userData.bondLengthShort;

                    }

                }

            }

            //

            function colorify( ctx, width, height, color, a ) {

                var r = color.r;
                var g = color.g;
                var b = color.b;

                var imageData = ctx.getImageData( 0, 0, width, height );
                var data = imageData.data;

                for ( var y = 0; y < height; y ++ ) {

                    for ( var x = 0; x < width; x ++ ) {

                        var index = ( y * width + x ) * 4;

                        data[ index ]     *= r;
                        data[ index + 1 ] *= g;
                        data[ index + 2 ] *= b;
                        data[ index + 3 ] *= a;

                    }

                }

                ctx.putImageData( imageData, 0, 0 );

            }

            function imageToCanvas( image ) {

                var width = image.width;
                var height = image.height;

                var canvas = document.createElement( 'canvas' );

                canvas.width = width;
                canvas.height = height;

                var context = canvas.getContext( '2d' );
                context.drawImage( image, 0, 0, width, height );

                return canvas;

            }

            //

            function loadMolecule( url ) {

                //TODO: see what objects is meant to be
                objects = [];

                for ( var i = 0; i < objects.length; i ++ ) {

                    var object = objects[ i ];

                    object.parent.remove( object );

                    if ( object.element.parentNode === renderer.cameraElement ) {

                        renderer.cameraElement.removeChild( object.element );

                    }

                    if ( object.userData.joint ) {

                        object.userData.joint.parent.remove( object.userData.joint );

                    }

                }

                var offset = THREE.GeometryUtils.center( geometry );
                    geometryBonds.applyMatrix( new THREE.Matrix4().makeTranslation( offset.x, offset.y, offset.z ) );




            }

            //

            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );

                render();

            }

            function animate() {

                requestAnimationFrame( animate );
                //controls.update();

                var time = Date.now() * 0.0004;

                root.rotation.x = time;
                root.rotation.y = time * 0.7;

                render();

            }

            function render() {

                renderer.render( scene, camera );

            }




    </script>